

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Jclian91">
  <meta name="keywords" content="">
  
    <meta name="description" content="本文将介绍如何在Firefly大模型训练框架中，使用LLAMA-2 7B模型，对多项选择阅读理解数据集RACE middle进行微调，最终效果提升明显。">
<meta property="og:type" content="article">
<meta property="og:title" content="NLP（七十）使用LLAMA-2模型微调Multiple-Choice-MRC">
<meta property="og:url" content="https://percent4.github.io/2024/01/09/NLP%EF%BC%88%E4%B8%83%E5%8D%81%EF%BC%89%E4%BD%BF%E7%94%A8LLAMA-2%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83Multiple-Choice-MRC/index.html">
<meta property="og:site_name" content="My Github Blog">
<meta property="og:description" content="本文将介绍如何在Firefly大模型训练框架中，使用LLAMA-2 7B模型，对多项选择阅读理解数据集RACE middle进行微调，最终效果提升明显。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/09/10/hJL4uqE7pl1aOWS.png">
<meta property="og:image" content="https://s2.loli.net/2023/09/10/9LMe2PdmZNKcCbo.png">
<meta property="og:image" content="https://s2.loli.net/2023/09/07/BFUl9i4872wWATx.jpg">
<meta property="og:image" content="https://s2.loli.net/2023/09/07/bYtEecQBfjRlUd1.jpg">
<meta property="article:published_time" content="2024-01-09T07:46:42.000Z">
<meta property="article:modified_time" content="2024-01-10T15:34:32.006Z">
<meta property="article:author" content="Jclian91">
<meta property="article:tag" content="LLM">
<meta property="article:tag" content="MRC">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://s2.loli.net/2023/09/10/hJL4uqE7pl1aOWS.png">
  
  
  
  <title>NLP（七十）使用LLAMA-2模型微调Multiple-Choice-MRC - My Github Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/csdn/iconfont.css">
<link rel="stylesheet" href="/css/toutiao/iconfont.css">
<link rel="stylesheet" href="/css/huggingface/iconfont.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"percent4.github.io","root":"/","version":"1.9.5-a","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"YUsFSnlfB9167rgyk6dKxO3n-gzGzoHsz","app_key":"MCARXkAOuxb8aiWTb3WdAsyn","server_url":"https://yusfsnlf.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="NLP（七十）使用LLAMA-2模型微调Multiple-Choice-MRC"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-01-09 15:46" pubdate>
          星期二, 一月 9日 2024, 3:46 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          7.4k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          62 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">NLP（七十）使用LLAMA-2模型微调Multiple-Choice-MRC</h1>
            
            
              <div class="markdown-body">
                
                <blockquote>
<p>本文将介绍如何在Firefly大模型训练框架中，使用LLAMA-2
7B模型，对多项选择阅读理解数据集RACE
middle进行微调，最终效果提升明显。</p>
</blockquote>
<h2 id="mrc">MRC</h2>
<p><code>机器阅读理解（Machine Reading Comprehension, MRC）</code>属于NLP任务中的问答任务（Question
Answering,
QA），是NLP领域中基础且重要的一项任务。所谓的机器阅读理解就是给定一篇文章，以及基于文章的一个问题，让机器在阅读文章后对问题进行作答。</p>
<p>根据任务形式的不同，可划分为：</p>
<figure>
<img src="https://s2.loli.net/2023/09/10/hJL4uqE7pl1aOWS.png" srcset="/img/loading.gif" lazyload
alt="四种MRC任务" />
<figcaption aria-hidden="true">四种MRC任务</figcaption>
</figure>
<ul>
<li><p>完形填空（Cloze
Tests）：将文章中的某些单词隐去，让模型根据上下文判断被隐去的单词最可能是哪个。</p></li>
<li><p>多项选择（Multiple
Choice）：给定一篇文章和一个问题，让模型从多个备选答案中选择一个最有可能是正确答案的选项。</p></li>
<li><p>片段抽取（Span
Extraction）：给定一篇文章和一个问题，让模型从文章中抽取连续的单词序列，并使得该序列尽可能的作为该问题的答案。</p></li>
<li><p>自由作答（Free
Answering）：给定一篇文章和一个问题，让模型生成一个单词序列，并使得该序列尽可能的作为该问题的答案。与片段抽取任务不同的是，该序列不再限制于是文章中的句子。</p></li>
</ul>
<p>其中，<code>完形填空</code>是BERT模型中的其中一项预训练任务MLM，因此，BERT系列的模型天然支持完形填空。</p>
<p><code>片段抽取</code>即抽取式阅读理解，是我们在NLP任务中最常见的阅读理解的形式，一般情况下的阅读理解也指的是这种形式。使用BERT系列模型也能很好地完成该任务。该任务的经典数据集有<a
target="_blank" rel="noopener" href="https://huggingface.co/datasets/squad">SQUAD</a>, <a
target="_blank" rel="noopener" href="https://huggingface.co/datasets/squad_v2">SQUAD 2</a>等。</p>
<p><code>自由作答</code>不限定回复的答案来自于原始文章，因此难度最大，一般采用生成式模型解决，以前的NLP模型在这方面的表现不佳。而大模型（LLM）的出现，让该任务有了很大改观，效果有了较强的阅读性，属于革命性的变化。</p>
<p><code>多项选择</code>即我们在英语考试中的阅读理解，阅读文章，给定问题，从固定的选项中选出正确答案。经典的多项选择阅读理解数据集有<a
target="_blank" rel="noopener" href="https://huggingface.co/datasets/race">RACE</a> , <a
target="_blank" rel="noopener" href="https://huggingface.co/datasets/swag">SWAG</a>等。本文将会具体介绍多项选择阅读理解中的RACE数据集，以及LLAMA-2
在该数据集上的微调效果。</p>
<h2 id="race数据集">RACE数据集</h2>
<p><code>RACE</code>数据集是多项选择阅读理解（Multi Choice
MRC）中的经典数据集，<a
target="_blank" rel="noopener" href="https://www.cs.cmu.edu/~glai1/data/race/">RACE官方网址</a>
中的介绍为：</p>
<blockquote>
<p>Race is a large-scale reading comprehension dataset with more than
28,000 passages and nearly 100,000 questions. The dataset is collected
from English examinations in China, which are designed for middle school
and high school students. The dataset can be served as the training and
test sets for machine comprehension.</p>
</blockquote>
<p>RACE数据集又分为middle（初中）和high（高中）两部分，如下：</p>
<table>
<thead>
<tr class="header">
<th>数据集</th>
<th>train</th>
<th>dev</th>
<th>test</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>middle</td>
<td>25421</td>
<td>1436</td>
<td>1436</td>
</tr>
<tr class="even">
<td>high</td>
<td>62445</td>
<td>3451</td>
<td>3498</td>
</tr>
<tr class="odd">
<td>total</td>
<td>87866</td>
<td>4887</td>
<td>4934</td>
</tr>
</tbody>
</table>
<p>由于数据规模原因和训练时间原因，本文只对middle数据集进行微调。随机从middle数据集中的训练集挑选一条样本，如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span>&#x27;example_id&#x27;<span class="hljs-punctuation">:</span> &#x27;middle4558.txt&#x27;<span class="hljs-punctuation">,</span><br> &#x27;article&#x27;<span class="hljs-punctuation">:</span> &#x27;<span class="hljs-string">&quot;I planted a seed. Finally grow fruits. Today is a great day. Pick off the star for you. Pick off the moon for you. Let it rise for you every day. Become candles burning myself. Just light you up, hey!... You are my little little apple. How much I love you, still no enough.&quot;</span>\nThis words are from the popular song You Are My Little Dear Apple. Bae Seul-Ki acted as the leading dancer in the MV of the song. She loves dancing. She became crazy about hip-hop when she was a school girl.\nBai Seul-Ki was born on September <span class="hljs-number">27</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1986.</span> She is a South Korean singer and dancer. She is <span class="hljs-number">168</span>cm tall. She loves cooking. Her favourite food is spicy and salty. She like pink and red most. There are five members in her family---father<span class="hljs-punctuation">,</span> mother<span class="hljs-punctuation">,</span> two younger brothers and herself. She isn\&#x27;t married.\nAfter her father and mother broke up<span class="hljs-punctuation">,</span> she lived with her mother and new daddy. She enjoys being alone.&#x27;<span class="hljs-punctuation">,</span><br> &#x27;answer&#x27;<span class="hljs-punctuation">:</span> &#x27;B&#x27;<span class="hljs-punctuation">,</span><br> &#x27;question&#x27;<span class="hljs-punctuation">:</span> &#x27;Bae Seul-Ki   _   in the MV of the song according to the passage.&#x27;<span class="hljs-punctuation">,</span><br> &#x27;options&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>&#x27;sang&#x27;<span class="hljs-punctuation">,</span> &#x27;danced&#x27;<span class="hljs-punctuation">,</span> &#x27;cried&#x27;<span class="hljs-punctuation">,</span> &#x27;laughed&#x27;<span class="hljs-punctuation">]</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<h2 id="构建prompt">构建Prompt</h2>
<p>本文针对RACE数据集，构建的Prompt如下：</p>
<pre><code class="hljs">Read the following passage and questions, then choose the right answer from options, the answer should be one of A, B, C, D.

&lt;passage&gt;:
&quot;I planted a seed. Finally grow fruits. Today is a great day. Pick off the star for you. Pick off the moon for you. Let it rise for you every day. Become candles burning myself. Just light you up, hey!... You are my little little apple. How much I love you, still no enough.&quot;
This words are from the popular song You Are My Little Dear Apple. Bae Seul-Ki acted as the leading dancer in the MV of the song. She loves dancing. She became crazy about hip-hop when she was a school girl.
Bai Seul-Ki was born on September 27, 1986. She is a South Korean singer and dancer. She is 168cm tall. She loves cooking. Her favourite food is spicy and salty. She like pink and red most. There are five members in her family---father, mother, two younger brothers and herself. She isn&#39;t married.
After her father and mother broke up, she lived with her mother and new daddy. She enjoys being alone.

&lt;question&gt;:
Bae Seul-Ki   _   in the MV of the song according to the passage.

&lt;options&gt;:
A sang
B danced
C cried
D laughed

&lt;answer&gt;:</code></pre>
<blockquote>
<p><strong>Trick</strong>:
可以借助大模型，比如GPT-4构建能好的Prompt以提升微调效果。</p>
</blockquote>
<h2 id="llama-2模型微调">LLAMA-2模型微调</h2>
<p>在大模型领域，<a
target="_blank" rel="noopener" href="https://research.facebook.com/publications/llama-open-and-efficient-foundation-language-models/"><code>LLAMA</code></a>系列模型可谓大名鼎鼎，其本身及衍生的模型有几十个，真让人眼花缭乱，而且效果都很不错，是大模型领域真正的一代宗师。我们有机会再介绍LLAMA系列模型，本文不再详述。</p>
<p>本文使用刚开源的<a
target="_blank" rel="noopener" href="https://about.fb.com/news/2023/07/llama-2/"><code>LLAMA 2</code>模型</a>，7B版本，在<code>Firefly</code>框架下，对RACE
middle数据集进行微调。微调的参数如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;output_dir&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;output/firefly-llama2-7b-race-middle&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;model_name_or_path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/home/jclian91/Llama-2-7b-hf&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;train_file&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./data/race_train.jsonl&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;num_train_epochs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;per_device_train_batch_size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;gradient_accumulation_steps&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;learning_rate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1e-4</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;max_seq_length&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">384</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;logging_steps&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;save_steps&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;save_total_limit&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;lr_scheduler_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;constant_with_warmup&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;warmup_steps&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;lora_rank&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">64</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;lora_alpha&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">16</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;lora_dropout&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.05</span><span class="hljs-punctuation">,</span><br><br>    <span class="hljs-attr">&quot;gradient_checkpointing&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;disable_tqdm&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;optim&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;paged_adamw_32bit&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;seed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">42</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;fp16&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;report_to&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;tensorboard&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;dataloader_num_workers&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;save_strategy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;steps&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;weight_decay&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;max_grad_norm&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.3</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;remove_unused_columns&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<p>在文章<a
target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzU2NTYyMDk5MQ==&amp;mid=2247485454&amp;idx=1&amp;sn=efe98ac6bef1d06518958918405719ab&amp;chksm=fcb9b19ecbce3888a57b9c7c8bc7852a7e051774ee897f5caa0a03d3afb0adf1aedc5bc5c11b&amp;payreadticket=HNZHAsM-Bua8lK8PnmTkk4-3mVg_01kmjA_KfhvBvh0iIMm1Tlz2woLFkuX8-weOLoMxOUU#rd">NLP（六十三）使用Baichuan-7b模型微调人物关系分类任务</a>，我们已经详细介绍了Firefly模型微调、评估、WEB服务等步骤，这里也不再详述。也可以参考Github项目<a
target="_blank" rel="noopener" href="https://github.com/percent4/llama-2-multiple-choice-mrc">llama-2-multiple-choice-mrc</a>
.</p>
<p>在RACE test数据集上的准确率为<code>86.91%</code>
!效果可谓惊人，而这只是LLAMA
2没有经过参数调整的结果，效果不可谓不佳。笔者之前用<a
target="_blank" rel="noopener" href="https://github.com/percent4/keras_bert_multiple_choice_MRC">BERT模型同样在RACE
middle数据集上进行微调</a>，评估结果一般只有72%左右，BERT
Large模型才不过75%，这还是训练数据采用了middle + high的结果。</p>
<p><a
target="_blank" rel="noopener" href="https://paperswithcode.com/sota/reading-comprehension-on-race">RACE数据集排行榜</a>如下：</p>
<figure>
<img src="https://s2.loli.net/2023/09/10/9LMe2PdmZNKcCbo.png" srcset="/img/loading.gif" lazyload
alt="RACE数据集排行榜" />
<figcaption aria-hidden="true">RACE数据集排行榜</figcaption>
</figure>
<h2 id="模型效果评估">模型效果评估</h2>
<p>最后，我们在新的文章上进行评估。我们从网上随机选取<a
target="_blank" rel="noopener" href="https://yingyu.xdf.cn/201901/10843790.html">一篇初中英语阅读理解文章</a>，如下：</p>
<pre><code class="hljs">Edward rose early on the New-year morning. He looked in every room and wished a Happy New Year to his family. Then he ran into the street to repeat that to those he might meet.

When he came back, his father gave him two bright, new silver dollars.

His face lighted up as he took them. He had wished for a long time to buy some pretty books that he had seen at the bookstore.

He left the house with a light heart, expecting to buy the books. As he ran down the street, he saw a poor family.

“I wish you a Happy New Year.” said Edward, as he was passing on. The man shook his head.

“You are not from this country.” said Edward. The man again shook his head, for he could not understand or speak his language. But he pointed to his mouth and to the children shaking with cold, as if (好像) to say, “These little ones have had nothing to eat for a long time.”

Edward quickly understood that these poor people were in trouble. He took out his dollars and gave one to the man, and the other to his wife.

They were excited and said something in their language, which doubtless meant, “We thank you so much that we will remember you all the time.”

When Edward came home, his father asked what books he had bought. He hung his head a moment, but quickly looked up.

“I have bought no books”, said he. “I gave my money to some poor people, who seemed to be very hungry then.” He went on, “I think I can wait for my books till next New Year.”

“My dear boy,” said his father, “here are some books for you, more as a prize for your goodness of heart than as a New-year gift”

“I saw you give the money cheerfully to the poor German family. It was nice for a little boy to do so. Be always ready to help others and every year of your life will be to you a Happy New Year.”</code></pre>
<p>四个问题如下：</p>
<pre><code class="hljs">48. Edward expected to _________ with the money he got from his father.

A. help the poor family B. buy something to eat

C. buy some pretty books D. learn another language

49. Why did the poor man shake his head when Edward spoke to him?

A. He couldn’t understand the boy B. He wouldn’t accept the money

C. He didn’t like the boy’s language D. He was too cold to say anything

50. How much did Edward give the poor family?

A. One dollar B. Two dollars C. Three dollars D. Four dollars

51. We know that Edward_________ from the passage?

A. got a prize for his kind heart B. had to buy his books next year

C. bought the books at the bookstore D. got more money from his father</code></pre>
<p>微调模型给出的答案为<strong>CABA</strong>，与参考答案一致！</p>
<h2 id="总结">总结</h2>
<p>多项选择阅读理解一直是笔者这几年来关注的人物，而之前的BERT时代，BERT模型的效果并不太好，<a
target="_blank" rel="noopener" href="https://huggingface.co/docs/transformers/model_doc/megatron-bert">Megatron-BERT</a>将指标提升至90%左右，这中间付出了太多努力，效果也不太好复现。笔者一直都在做这方面的努力，而囿于机器资源或模型参数，都未能成功。LLAMA系列模型的出现，让这一切变得如此轻松写意，虽然效果还不是SOTA，但效果无疑是让人满意的。大模型无疑是未来人工智能的潮流，是当今时代的弄潮儿！</p>
<p>本文主要介绍了MRC及RACE数据集，同时介绍了如何在Firefly训练框架下，采用LLAMA
2模型进行微调，并取得了满意的效果。</p>
<p>欢迎关注我的公众号<strong>NLP奇幻之旅</strong>，原创技术文章第一时间推送。</p>
<center>
<img src="https://s2.loli.net/2023/09/07/BFUl9i4872wWATx.jpg" srcset="/img/loading.gif" lazyload style="width:200px;">
</center>
<p>欢迎关注我的知识星球“<strong>自然语言处理奇幻之旅</strong>”，笔者正在努力构建自己的技术社区。</p>
<center>
<img src="https://s2.loli.net/2023/09/07/bYtEecQBfjRlUd1.jpg" srcset="/img/loading.gif" lazyload style="width:200px;">
</center>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/NLP/" class="category-chain-item">NLP</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/LLM/" class="print-no-link">#LLM</a>
      
        <a href="/tags/MRC/" class="print-no-link">#MRC</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>NLP（七十）使用LLAMA-2模型微调Multiple-Choice-MRC</div>
      <div>https://percent4.github.io/2024/01/09/NLP（七十）使用LLAMA-2模型微调Multiple-Choice-MRC/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Jclian91</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年1月9日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/01/09/Apollo%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%8F%8APython%E8%BF%9E%E6%8E%A5/" title="Apollo配置中心及Python连接">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Apollo配置中心及Python连接</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/09/09/NLP%EF%BC%88%E5%85%AD%E5%8D%81%E4%B9%9D%EF%BC%89%E6%99%BA%E8%83%BD%E6%96%87%E6%A1%A3%E5%8A%A9%E6%89%8B%E5%8D%87%E7%BA%A7/" title="NLP（六十九）智能文档助手升级">
                        <span class="hidden-mobile">NLP（六十九）智能文档助手升级</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"YUsFSnlfB9167rgyk6dKxO3n-gzGzoHsz","appKey":"MCARXkAOuxb8aiWTb3WdAsyn","path":"window.location.pathname","placeholder":"文章对您有启发吗？","avatar":"retro","meta":["nick"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":true,"recordIP":true,"serverURLs":"https://yusfsnlf.lc-cn-n1-shared.com","emojiCDN":null,"emojiMaps":null,"enableQQ":false,"appid":"YUsFSnlfB9167rgyk6dKxO3n-gzGzoHsz","appkey":"MCARXkAOuxb8aiWTb3WdAsyn","mathJax":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <br> <span id="runtime_span"></span> <script type="text/javascript">function show_runtime(){window.setTimeout("show_runtime()",1000);X=new Date("7/6/2023 13:03:50");Y=new Date();T=(Y.getTime()-X.getTime());M=24*60*60*1000;a=T/M;A=Math.floor(a);b=(a-A)*24;B=Math.floor(b);c=(b-B)*60;C=Math.floor((b-B)*60);D=Math.floor((c-C)*60);runtime_span.innerHTML="本站已运行"+A+"天"+B+"小时"+C+"分"+D+"秒"}show_runtime();</script> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
