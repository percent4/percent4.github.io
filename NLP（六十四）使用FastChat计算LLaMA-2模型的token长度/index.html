

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Jclian91">
  <meta name="keywords" content="">
  
    <meta name="description" content="本文将会介绍如何使用FastChat计算LLaMA-2模型的token长度，包括Prompt的token长度以及对话的token长度。">
<meta property="og:type" content="article">
<meta property="og:title" content="NLP（六十四）使用FastChat计算LLaMA-2模型的token长度">
<meta property="og:url" content="https://percent4.github.io/NLP%EF%BC%88%E5%85%AD%E5%8D%81%E5%9B%9B%EF%BC%89%E4%BD%BF%E7%94%A8FastChat%E8%AE%A1%E7%AE%97LLaMA-2%E6%A8%A1%E5%9E%8B%E7%9A%84token%E9%95%BF%E5%BA%A6/index.html">
<meta property="og:site_name" content="My Github Blog">
<meta property="og:description" content="本文将会介绍如何使用FastChat计算LLaMA-2模型的token长度，包括Prompt的token长度以及对话的token长度。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-08-08T15:08:02.000Z">
<meta property="article:modified_time" content="2024-01-10T15:51:46.414Z">
<meta property="article:author" content="Jclian91">
<meta property="article:tag" content="NLP">
<meta property="article:tag" content="AIGC">
<meta property="article:tag" content="FastChat">
<meta property="article:tag" content="LLaMA-2">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>NLP（六十四）使用FastChat计算LLaMA-2模型的token长度 - My Github Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/csdn/iconfont.css">
<link rel="stylesheet" href="/css/toutiao/iconfont.css">
<link rel="stylesheet" href="/css/huggingface/iconfont.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"percent4.github.io","root":"/","version":"1.9.5-a","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"YUsFSnlfB9167rgyk6dKxO3n-gzGzoHsz","app_key":"MCARXkAOuxb8aiWTb3WdAsyn","server_url":"https://yusfsnlf.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  
    
  



  
  <meta name="google-site-verification" content="iwt9R4ZjOOtNMseCGP-F5CgwNqJSQ8hf1OsBse50Cyo" />
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="NLP（六十四）使用FastChat计算LLaMA-2模型的token长度"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-08-08 23:08" pubdate>
          星期二, 八月 8日 2023, 11:08 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          12k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          98 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">NLP（六十四）使用FastChat计算LLaMA-2模型的token长度</h1>
            
            
              <div class="markdown-body">
                
                <h3 id="llama-2模型部署">LLaMA-2模型部署</h3>
<p>在文章<a
href="https://percent4.github.io/2023/07/11/NLP%EF%BC%88%E4%BA%94%E5%8D%81%E4%B9%9D%EF%BC%89%E4%BD%BF%E7%94%A8FastChat%E9%83%A8%E7%BD%B2%E7%99%BE%E5%B7%9D%E5%A4%A7%E6%A8%A1%E5%9E%8B/">NLP（五十九）使用FastChat部署百川大模型</a>中，笔者介绍了<code>FastChat</code>框架，以及如何使用<code>FastChat</code>来部署百川模型。</p>
<p>本文将会部署LLaMA-2
70B模型，使得其兼容OpenAI的调用风格。部署的<code>Dockerfile</code>文件如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">FROM</span> <span class="hljs-string">nvidia/cuda:11.7.1-runtime-ubuntu20.04</span><br><br><span class="hljs-string">RUN</span> <span class="hljs-string">apt-get</span> <span class="hljs-string">update</span> <span class="hljs-string">-y</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">apt-get</span> <span class="hljs-string">install</span> <span class="hljs-string">-y</span> <span class="hljs-string">python3.9</span> <span class="hljs-string">python3.9-distutils</span> <span class="hljs-string">curl</span><br><span class="hljs-string">RUN</span> <span class="hljs-string">curl</span> <span class="hljs-string">https://bootstrap.pypa.io/get-pip.py</span> <span class="hljs-string">-o</span> <span class="hljs-string">get-pip.py</span><br><span class="hljs-string">RUN</span> <span class="hljs-string">python3.9</span> <span class="hljs-string">get-pip.py</span><br><span class="hljs-string">RUN</span> <span class="hljs-string">pip3</span> <span class="hljs-string">install</span> <span class="hljs-string">fschat</span><br></code></pre></td></tr></table></figure>
<p><code>Docker-compose.yml</code>文件如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">version:</span> <span class="hljs-string">&quot;3.9&quot;</span><br><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">fastchat-controller:</span><br>    <span class="hljs-attr">build:</span><br>      <span class="hljs-attr">context:</span> <span class="hljs-string">.</span><br>      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">Dockerfile</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">fastchat:latest</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;21001:21001&quot;</span><br>    <span class="hljs-attr">entrypoint:</span> [<span class="hljs-string">&quot;python3.9&quot;</span>, <span class="hljs-string">&quot;-m&quot;</span>, <span class="hljs-string">&quot;fastchat.serve.controller&quot;</span>, <span class="hljs-string">&quot;--host&quot;</span>, <span class="hljs-string">&quot;0.0.0.0&quot;</span>, <span class="hljs-string">&quot;--port&quot;</span>, <span class="hljs-string">&quot;21001&quot;</span>]<br><br>  <span class="hljs-attr">fastchat-model-worker:</span><br>    <span class="hljs-attr">build:</span><br>      <span class="hljs-attr">context:</span> <span class="hljs-string">.</span><br>      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">Dockerfile</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./model:/root/model</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">fastchat:latest</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;21002:21002&quot;</span><br>    <span class="hljs-attr">deploy:</span><br>      <span class="hljs-attr">resources:</span><br>        <span class="hljs-attr">reservations:</span><br>          <span class="hljs-attr">devices:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">driver:</span> <span class="hljs-string">nvidia</span><br>              <span class="hljs-attr">device_ids:</span> [<span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>]<br>              <span class="hljs-attr">capabilities:</span> [<span class="hljs-string">gpu</span>]<br>    <span class="hljs-attr">entrypoint:</span> [<span class="hljs-string">&quot;python3.9&quot;</span>, <span class="hljs-string">&quot;-m&quot;</span>, <span class="hljs-string">&quot;fastchat.serve.model_worker&quot;</span>, <span class="hljs-string">&quot;--model-names&quot;</span>, <span class="hljs-string">&quot;llama2-70b-chat&quot;</span>, <span class="hljs-string">&quot;--model-path&quot;</span>, <span class="hljs-string">&quot;/root/model/llama2/Llama-2-70b-chat-hf&quot;</span>, <span class="hljs-string">&quot;--num-gpus&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>, <span class="hljs-string">&quot;--gpus&quot;</span>,  <span class="hljs-string">&quot;0,1&quot;</span>, <span class="hljs-string">&quot;--worker-address&quot;</span>, <span class="hljs-string">&quot;http://fastchat-model-worker:21002&quot;</span>, <span class="hljs-string">&quot;--controller-address&quot;</span>, <span class="hljs-string">&quot;http://fastchat-controller:21001&quot;</span>, <span class="hljs-string">&quot;--host&quot;</span>, <span class="hljs-string">&quot;0.0.0.0&quot;</span>, <span class="hljs-string">&quot;--port&quot;</span>, <span class="hljs-string">&quot;21002&quot;</span>]<br><br>  <span class="hljs-attr">fastchat-api-server:</span><br>    <span class="hljs-attr">build:</span><br>      <span class="hljs-attr">context:</span> <span class="hljs-string">.</span><br>      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">Dockerfile</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">fastchat:latest</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;8000:8000&quot;</span><br>    <span class="hljs-attr">entrypoint:</span> [<span class="hljs-string">&quot;python3.9&quot;</span>, <span class="hljs-string">&quot;-m&quot;</span>, <span class="hljs-string">&quot;fastchat.serve.openai_api_server&quot;</span>, <span class="hljs-string">&quot;--controller-address&quot;</span>, <span class="hljs-string">&quot;http://fastchat-controller:21001&quot;</span>, <span class="hljs-string">&quot;--host&quot;</span>, <span class="hljs-string">&quot;0.0.0.0&quot;</span>, <span class="hljs-string">&quot;--port&quot;</span>, <span class="hljs-string">&quot;8000&quot;</span>]<br></code></pre></td></tr></table></figure>
<p>部署成功后，会占用2张A100，每张A100占用约66G显存。</p>
<p>测试模型是否部署成功：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl http://localhost:8000/v1/models<br></code></pre></td></tr></table></figure>
<p>输出结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;object&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;list&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;data&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;llama2-70b-chat&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;object&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;model&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;created&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1691504717</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;owned_by&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;fastchat&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;root&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;llama2-70b-chat&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;parent&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;permission&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;modelperm-3XG6nzMAqfEkwfNqQ52fdv&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;object&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;model_permission&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;created&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1691504717</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;allow_create_engine&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;allow_sampling&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;allow_logprobs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;allow_search_indices&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;allow_view&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;allow_fine_tuning&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;organization&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;*&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;group&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;is_blocking&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<p>部署LLaMA-2 70B模型成功！</p>
<h3 id="prompt-token长度计算">Prompt token长度计算</h3>
<p>在<code>FastChat</code>的Github开源项目中，项目提供了计算Prompt的token长度的API，文件路径为：fastchat/serve/model_worker.py，调用方法为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs curl">curl --location &#x27;localhost:21002/count_token&#x27; \<br>--header &#x27;Content-Type: application/json&#x27; \<br>--data &#x27;&#123;&quot;prompt&quot;: &quot;What is your name?&quot;&#125;&#x27;<br></code></pre></td></tr></table></figure>
<p>输出结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;count&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;error_code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<h3 id="conversation-token长度计算">Conversation token长度计算</h3>
<p>在<code>FastChat</code>中计算Conversation（对话）的token长度较为麻烦。</p>
<p>首先我们需要获取LLaMA-2
70B模型的<code>对话配置</code>，调用API如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl --location --request POST <span class="hljs-string">&#x27;http://localhost:21002/worker_get_conv_template&#x27;</span><br></code></pre></td></tr></table></figure>
<p>输出结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span>&#x27;conv&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span>&#x27;messages&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>          &#x27;name&#x27;<span class="hljs-punctuation">:</span> &#x27;llama<span class="hljs-number">-2</span>&#x27;<span class="hljs-punctuation">,</span><br>          &#x27;offset&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>          &#x27;roles&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>&#x27;<span class="hljs-punctuation">[</span>INST<span class="hljs-punctuation">]</span>&#x27;<span class="hljs-punctuation">,</span> &#x27;<span class="hljs-punctuation">[</span>/INST<span class="hljs-punctuation">]</span>&#x27;<span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>          &#x27;sep&#x27;<span class="hljs-punctuation">:</span> &#x27; &#x27;<span class="hljs-punctuation">,</span><br>          &#x27;sep2&#x27;<span class="hljs-punctuation">:</span> &#x27; &lt;/s&gt;&lt;s&gt;&#x27;<span class="hljs-punctuation">,</span><br>          &#x27;sep_style&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span><br>          &#x27;stop_str&#x27;<span class="hljs-punctuation">:</span> None<span class="hljs-punctuation">,</span><br>          &#x27;stop_token_ids&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">2</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>          &#x27;system_message&#x27;<span class="hljs-punctuation">:</span> &#x27;You are a helpful<span class="hljs-punctuation">,</span> respectful and honest &#x27;<br>                            &#x27;assistant. Always answer as helpfully as &#x27;<br>                            &#x27;possible<span class="hljs-punctuation">,</span> while being safe. Your answers should &#x27;<br>                            &#x27;not include any harmful<span class="hljs-punctuation">,</span> unethical<span class="hljs-punctuation">,</span> racist<span class="hljs-punctuation">,</span> &#x27;<br>                            &#x27;sexist<span class="hljs-punctuation">,</span> toxic<span class="hljs-punctuation">,</span> dangerous<span class="hljs-punctuation">,</span> or illegal content. &#x27;<br>                            &#x27;Please ensure that your responses are socially &#x27;<br>                            &#x27;unbiased and positive in nature.\n&#x27;<br>                            &#x27;\n&#x27;<br>                            &#x27;If a question does not make any sense<span class="hljs-punctuation">,</span> or is not &#x27;<br>                            &#x27;factually coherent<span class="hljs-punctuation">,</span> explain why instead of &#x27;<br>                            <span class="hljs-string">&quot;answering something not correct. If you don&#x27;t &quot;</span><br>                            <span class="hljs-string">&quot;know the answer to a question, please don&#x27;t share &quot;</span><br>                            &#x27;<span class="hljs-literal"><span class="hljs-keyword">false</span></span> information.&#x27;<span class="hljs-punctuation">,</span><br>          &#x27;system_template&#x27;<span class="hljs-punctuation">:</span> &#x27;<span class="hljs-punctuation">[</span>INST<span class="hljs-punctuation">]</span> &lt;&lt;SYS&gt;&gt;\n<span class="hljs-punctuation">&#123;</span>system_message<span class="hljs-punctuation">&#125;</span>\n&lt;&lt;/SYS&gt;&gt;\n\n&#x27;<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<p>在<code>FastChat</code>中的对话文件（fastchat/conversation.py）中，提供了对话加工的代码，这里不再展示，使用时直接复制整个文件即可，该文件不依赖任何第三方模块。</p>
<p>我们需要将对话按照OpenAI的方式加工成对应的Prompt，输入的对话（messages）如下：</p>
<blockquote>
<p>messages = [{"role": "system", "content": "You are Jack, you are 20
years old, answer questions with humor."}, {"role": "user", "content":
"What is your name?"},{"role": "assistant", "content": " Well, well,
well! Look who's asking the questions now! My name is Jack, but you can
call me the king of the castle, the lord of the rings, or the prince of
the pizza party. Whatever floats your boat, my friend!"}, {"role":
"user", "content": "How old are you?"}, {"role": "assistant", "content":
" Oh, you want to know my age? Well, let's just say I'm older than a
bottle of wine but younger than a bottle of whiskey. I'm like a fine
cheese, getting better with age, but still young enough to party like
it's 1999!"}, {"role": "user", "content": "Where is your
hometown?"}]</p>
</blockquote>
<p>Python代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-comment"># @place: Pudong, Shanghai </span><br><span class="hljs-comment"># @file: prompt.py</span><br><span class="hljs-comment"># @time: 2023/8/8 19:24</span><br><span class="hljs-keyword">from</span> conversation <span class="hljs-keyword">import</span> Conversation, SeparatorStyle<br><br>messages = [&#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;You are Jack, you are 20 years old, answer questions with humor.&quot;</span>&#125;, &#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;What is your name?&quot;</span>&#125;,&#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;assistant&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot; Well, well, well! Look who&#x27;s asking the questions now! My name is Jack, but you can call me the king of the castle, the lord of the rings, or the prince of the pizza party. Whatever floats your boat, my friend!&quot;</span>&#125;, &#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;How old are you?&quot;</span>&#125;, &#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;assistant&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot; Oh, you want to know my age? Well, let&#x27;s just say I&#x27;m older than a bottle of wine but younger than a bottle of whiskey. I&#x27;m like a fine cheese, getting better with age, but still young enough to party like it&#x27;s 1999!&quot;</span>&#125;, &#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;Where is your hometown?&quot;</span>&#125;]<br><br>llama2_conv = &#123;<span class="hljs-string">&quot;conv&quot;</span>:&#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;llama-2&quot;</span>,<span class="hljs-string">&quot;system_template&quot;</span>:<span class="hljs-string">&quot;[INST] &lt;&lt;SYS&gt;&gt;\n&#123;system_message&#125;\n&lt;&lt;/SYS&gt;&gt;\n\n&quot;</span>,<span class="hljs-string">&quot;system_message&quot;</span>:<span class="hljs-string">&quot;You are a helpful, respectful and honest assistant. Always answer as helpfully as possible, while being safe. Your answers should not include any harmful, unethical, racist, sexist, toxic, dangerous, or illegal content. Please ensure that your responses are socially unbiased and positive in nature.\n\nIf a question does not make any sense, or is not factually coherent, explain why instead of answering something not correct. If you don&#x27;t know the answer to a question, please don&#x27;t share false information.&quot;</span>,<span class="hljs-string">&quot;roles&quot;</span>:[<span class="hljs-string">&quot;[INST]&quot;</span>,<span class="hljs-string">&quot;[/INST]&quot;</span>],<span class="hljs-string">&quot;messages&quot;</span>:[],<span class="hljs-string">&quot;offset&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;sep_style&quot;</span>:<span class="hljs-number">7</span>,<span class="hljs-string">&quot;sep&quot;</span>:<span class="hljs-string">&quot; &quot;</span>,<span class="hljs-string">&quot;sep2&quot;</span>:<span class="hljs-string">&quot; &lt;/s&gt;&lt;s&gt;&quot;</span>,<span class="hljs-string">&quot;stop_str&quot;</span>:<span class="hljs-literal">None</span>,<span class="hljs-string">&quot;stop_token_ids&quot;</span>:[<span class="hljs-number">2</span>]&#125;&#125;<br>conv = llama2_conv[<span class="hljs-string">&#x27;conv&#x27;</span>]<br><br>conv = Conversation(<br>        name=conv[<span class="hljs-string">&quot;name&quot;</span>],<br>        system_template=conv[<span class="hljs-string">&quot;system_template&quot;</span>],<br>        system_message=conv[<span class="hljs-string">&quot;system_message&quot;</span>],<br>        roles=conv[<span class="hljs-string">&quot;roles&quot;</span>],<br>        messages=<span class="hljs-built_in">list</span>(conv[<span class="hljs-string">&quot;messages&quot;</span>]),  <span class="hljs-comment"># prevent in-place modification</span><br>        offset=conv[<span class="hljs-string">&quot;offset&quot;</span>],<br>        sep_style=SeparatorStyle(conv[<span class="hljs-string">&quot;sep_style&quot;</span>]),<br>        sep=conv[<span class="hljs-string">&quot;sep&quot;</span>],<br>        sep2=conv[<span class="hljs-string">&quot;sep2&quot;</span>],<br>        stop_str=conv[<span class="hljs-string">&quot;stop_str&quot;</span>],<br>        stop_token_ids=conv[<span class="hljs-string">&quot;stop_token_ids&quot;</span>],<br>    )<br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(messages, <span class="hljs-built_in">str</span>):<br>    prompt = messages<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-keyword">for</span> message <span class="hljs-keyword">in</span> messages:<br>        msg_role = message[<span class="hljs-string">&quot;role&quot;</span>]<br>        <span class="hljs-keyword">if</span> msg_role == <span class="hljs-string">&quot;system&quot;</span>:<br>            conv.set_system_message(message[<span class="hljs-string">&quot;content&quot;</span>])<br>        <span class="hljs-keyword">elif</span> msg_role == <span class="hljs-string">&quot;user&quot;</span>:<br>            conv.append_message(conv.roles[<span class="hljs-number">0</span>], message[<span class="hljs-string">&quot;content&quot;</span>])<br>        <span class="hljs-keyword">elif</span> msg_role == <span class="hljs-string">&quot;assistant&quot;</span>:<br>            conv.append_message(conv.roles[<span class="hljs-number">1</span>], message[<span class="hljs-string">&quot;content&quot;</span>])<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;Unknown role: <span class="hljs-subst">&#123;msg_role&#125;</span>&quot;</span>)<br><br>    <span class="hljs-comment"># Add a blank message for the assistant.</span><br>    conv.append_message(conv.roles[<span class="hljs-number">1</span>], <span class="hljs-literal">None</span>)<br>    prompt = conv.get_prompt()<br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">repr</span>(prompt))<br></code></pre></td></tr></table></figure>
<p>加工后的Prompt如下：</p>
<figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs smalltalk"><span class="hljs-comment">&quot;[INST] &lt;&lt;SYS&gt;&gt;\nYou are Jack, you are 20 years old, answer questions with humor.\n&lt;&lt;/SYS&gt;&gt;\n\nWhat is your name?[/INST]  Well, well, well! Look who&#x27;s asking the questions now! My name is Jack, but you can call me the king of the castle, the lord of the rings, or the prince of the pizza party. Whatever floats your boat, my friend! &lt;/s&gt;&lt;s&gt;[INST] How old are you? [/INST]  Oh, you want to know my age? Well, let&#x27;s just say I&#x27;m older than a bottle of wine but younger than a bottle of whiskey. I&#x27;m like a fine cheese, getting better with age, but still young enough to party like it&#x27;s 1999! &lt;/s&gt;&lt;s&gt;[INST] Where is your hometown? [/INST]&quot;</span><br></code></pre></td></tr></table></figure>
<p>最后再调用计算Prompt的API（参考上节的Prompt
token长度计算），输出该对话的token长度为199.</p>
<p>我们使用<code>FastChat</code>提供的对话补充接口（v1/chat/completions）<code>验证</code>输入的对话token长度，请求命令为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl --location <span class="hljs-string">&#x27;http://localhost:8000/v1/chat/completions&#x27;</span> \<br>--header <span class="hljs-string">&#x27;Content-Type: application/json&#x27;</span> \<br>--data <span class="hljs-string">&#x27;&#123;</span><br><span class="hljs-string">    &quot;model&quot;: &quot;llama2-70b-chat&quot;,</span><br><span class="hljs-string">    &quot;messages&quot;: [&#123;&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;You are Jack, you are 20 years old, answer questions with humor.&quot;&#125;, &#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;What is your name?&quot;&#125;,&#123;&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot; Well, well, well! Look who&#x27;</span>\<span class="hljs-string">&#x27;&#x27;</span>s asking the questions now! My name is Jack, but you can call me the king of the castle, the lord of the rings, or the prince of the pizza party. Whatever floats your boat, my friend!<span class="hljs-string">&quot;&#125;, &#123;&quot;</span>role<span class="hljs-string">&quot;: &quot;</span>user<span class="hljs-string">&quot;, &quot;</span>content<span class="hljs-string">&quot;: &quot;</span>How old are you?<span class="hljs-string">&quot;&#125;, &#123;&quot;</span>role<span class="hljs-string">&quot;: &quot;</span>assistant<span class="hljs-string">&quot;, &quot;</span>content<span class="hljs-string">&quot;: &quot;</span> Oh, you want to know my age? Well, <span class="hljs-built_in">let</span><span class="hljs-string">&#x27;\&#x27;</span><span class="hljs-string">&#x27;s just say I&#x27;</span>\<span class="hljs-string">&#x27;&#x27;</span>m older than a bottle of wine but younger than a bottle of whiskey. I<span class="hljs-string">&#x27;\&#x27;</span><span class="hljs-string">&#x27;m like a fine cheese, getting better with age, but still young enough to party like it&#x27;</span>\<span class="hljs-string">&#x27;&#x27;</span>s 1999!<span class="hljs-string">&quot;&#125;, &#123;&quot;</span>role<span class="hljs-string">&quot;: &quot;</span>user<span class="hljs-string">&quot;, &quot;</span>content<span class="hljs-string">&quot;: &quot;</span>Where is your hometown?<span class="hljs-string">&quot;&#125;]</span><br><span class="hljs-string">&#125;&#x27;</span><br></code></pre></td></tr></table></figure>
<p>输出结果为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;chatcmpl-mQxcaQcNSNMFahyHS7pamA&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;object&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;chat.completion&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;created&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1691506768</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;model&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;llama2-70b-chat&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;choices&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;role&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;assistant&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot; Ha! My hometown? Well, that&#x27;s a tough one. I&#x27;m like a bird, I don&#x27;t have a nest, I just fly around and land wherever the wind takes me. But if you really want to know, I&#x27;m from a place called \&quot;The Internet\&quot;. It&#x27;s a magical land where memes and cat videos roam free, and the Wi-Fi is always strong. It&#x27;s a beautiful place, you should visit sometime!&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;finish_reason&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;stop&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;usage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;prompt_tokens&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">199</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;total_tokens&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">302</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;completion_tokens&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">103</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<p>注意，输出的prompt_tokens为199，这与我们刚才计算的对话token长度的结果是一致的！</p>
<h3 id="总结">总结</h3>
<p>本文主要介绍了如何在FastChat中部署LLaMA-2 70B模型，并详细介绍了Prompt
token长度计算以及对话（conversation）的token长度计算。希望能对读者有所帮助~</p>
<p>笔者的一点心得是：阅读源码真的很重要。</p>
<p>笔者的个人博客网址为：<a
href="https://percent4.github.io/">https://percent4.github.io/</a>
,欢迎大家访问~</p>
<h3 id="参考网址">参考网址</h3>
<ol type="1">
<li><p>NLP（五十九）使用FastChat部署百川大模型: <a
href="https://percent4.github.io/2023/07/11/NLP%EF%BC%88%E4%BA%94%E5%8D%81%E4%B9%9D%EF%BC%89%E4%BD%BF%E7%94%A8FastChat%E9%83%A8%E7%BD%B2%E7%99%BE%E5%B7%9D%E5%A4%A7%E6%A8%A1%E5%9E%8B/">https://blog.csdn.net/jclian91/article/details/131650918</a></p></li>
<li><p>FastChat: <a
target="_blank" rel="noopener" href="https://github.com/lm-sys/FastChat">https://github.com/lm-sys/FastChat</a></p></li>
</ol>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/NLP/" class="category-chain-item">NLP</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/NLP/" class="print-no-link">#NLP</a>
      
        <a href="/tags/AIGC/" class="print-no-link">#AIGC</a>
      
        <a href="/tags/FastChat/" class="print-no-link">#FastChat</a>
      
        <a href="/tags/LLaMA-2/" class="print-no-link">#LLaMA-2</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>NLP（六十四）使用FastChat计算LLaMA-2模型的token长度</div>
      <div>https://percent4.github.io/NLP（六十四）使用FastChat计算LLaMA-2模型的token长度/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Jclian91</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年8月8日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/NLP%EF%BC%88%E5%85%AD%E5%8D%81%E4%BA%94%EF%BC%89LangChain%E4%B8%AD%E7%9A%84%E9%87%8D%E8%BF%9E%EF%BC%88retry%EF%BC%89%E6%9C%BA%E5%88%B6/" title="NLP（六十五）LangChain中的重连（retry）机制">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">NLP（六十五）LangChain中的重连（retry）机制</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/Keras%E5%85%A5%E9%97%A8%EF%BC%88%E5%85%AB%EF%BC%89K%E6%8A%98%E4%BA%A4%E5%8F%89%E9%AA%8C%E8%AF%81/" title="Keras入门（八）K折交叉验证">
                        <span class="hidden-mobile">Keras入门（八）K折交叉验证</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"YUsFSnlfB9167rgyk6dKxO3n-gzGzoHsz","appKey":"MCARXkAOuxb8aiWTb3WdAsyn","path":"window.location.pathname","placeholder":"文章对您有启发吗？","avatar":"retro","meta":["nick"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":true,"recordIP":true,"serverURLs":"https://yusfsnlf.lc-cn-n1-shared.com","emojiCDN":null,"emojiMaps":null,"enableQQ":false,"appid":"YUsFSnlfB9167rgyk6dKxO3n-gzGzoHsz","appkey":"MCARXkAOuxb8aiWTb3WdAsyn","mathJax":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <br> <span id="runtime_span"></span> <script type="text/javascript">function show_runtime(){window.setTimeout("show_runtime()",1000);X=new Date("7/6/2023 13:03:50");Y=new Date();T=(Y.getTime()-X.getTime());M=24*60*60*1000;a=T/M;A=Math.floor(a);b=(a-A)*24;B=Math.floor(b);c=(b-B)*60;C=Math.floor((b-B)*60);D=Math.floor((c-C)*60);runtime_span.innerHTML="本站已运行"+A+"天"+B+"小时"+C+"分"+D+"秒"}show_runtime();</script> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
